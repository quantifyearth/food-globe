<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agricultural Impact Globe</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        #globe-container {
            width: 100vw;
            height: 100vh;
        }
        
        /* Mobile menu toggle button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 2001;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #4CAF50;
            color: #4CAF50;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        .mobile-menu-toggle:hover {
            background: rgba(76, 175, 80, 0.2);
        }
        
        /* Overlay for mobile panels */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            width: 280px;
            max-width: calc(100vw - 40px);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .commodity-selector {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
            position: relative;
        }

        .commodity-selector label {
            display: block;
            margin-bottom: 8px;
            color: #4CAF50;
            font-size: 14px;
            font-weight: bold;
        }

        .commodity-selector input {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 13px;
        }

        .commodity-selector input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .commodity-selector input::placeholder {
            color: #888;
        }
        
        .commodity-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #444;
            border-top: none;
            border-radius: 0 0 4px 4px;
            display: none;
            z-index: 1001;
        }
        
        .commodity-dropdown.show {
            display: block;
        }
        
        .commodity-option {
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #ccc;
            border-bottom: 1px solid rgba(68, 68, 68, 0.3);
        }
        
        .commodity-option:hover,
        .commodity-option.highlighted {
            background: rgba(76, 175, 80, 0.2);
            color: #fff;
        }
        
        .commodity-option.selected {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            font-weight: bold;
        }
        
        .commodity-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 4px;
            display: none;
        }
        
        .commodity-clear:hover {
            color: #fff;
        }
        
        .commodity-selector.has-value .commodity-clear {
            display: block;
        }

        .selected-country {
            font-size: 14px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .country-info {
            font-size: 12px;
            color: #ccc;
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            width: 280px;
            max-width: calc(100vw - 40px);
            z-index: 1000;
            font-size: 12px;
        }
        
        /* Simplified mobile message */
        .mobile-message {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #4CAF50;
            font-size: 12px;
            color: #4CAF50;
            z-index: 1000;
            text-align: center;
            max-width: calc(100vw - 20px);
        }

        .data-inbox {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            width: 280px;
            max-width: calc(100vw - 40px);
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .data-inbox > h3 {
            margin: 0 0 10px 0;
            padding: 8px;
            padding-right: 45px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            position: relative;
        }
        
        .data-inbox > h3 .main-title {
            color: #4CAF50;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-inbox > h3 .variance-info {
            font-size: 10px;
            color: #aaa;
            text-transform: none;
            letter-spacing: normal;
            margin-top: 4px;
        }
        
        .data-inbox > h3 .variance-value {
            color: #fff;
            font-weight: bold;
        }
        
        .data-inbox h3:not(#data-inbox-header) {
            margin: 0 0 6px 0;
            color: #4CAF50;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        
        .section-stats {
            font-size: 11px;
            color: #aaa;
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
        }
        
        .see-more-btn {
            margin: 8px 0;
            padding: 4px 8px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .see-more-btn:hover {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }
        
        .data-item.collapsed {
            display: none;
        }

        .data-item {
            margin-bottom: 4px;
            padding: 4px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s;
        }
        
        .data-item.international-item:hover {
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .impact-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05));
            z-index: 0;
            border-radius: 0 4px 4px 0;
        }
        
        .data-item-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-item-info {
            flex: 1;
        }

        .data-item.high-impact {
            border-left-color: #ff4444;
        }

        .data-item.medium-impact {
            border-left-color: #ffaa44;
        }

        .data-item.low-impact {
            border-left-color: #44ff44;
        }

        .commodity-name {
            font-weight: bold;
            color: #fff;
            flex: 1;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .commodity-name:hover {
            color: #4CAF50;
            text-decoration: underline;
        }

        .source-country {
            color: #aaa;
            font-size: 11px;
            margin-top: 2px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .source-country:hover {
            color: #4CAF50;
            text-decoration: underline;
        }

        .impact-value {
            font-family: monospace;
            font-size: 11px;
            margin-left: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }
        
        .impact-score {
            font-weight: bold;
        }
        
        .impact-rank {
            font-size: 9px;
            opacity: 0.8;
        }
        
        .impact-value.high-impact-value {
            color: #ff6666;
        }
        
        .impact-value.medium-impact-value {
            color: #ffbb66;
        }
        
        .impact-value.low-impact-value {
            color: #66ff66;
        }
        
        /* Tablet styles (768px - 1024px) - panels already sized correctly above */
        @media screen and (max-width: 1024px) {
            .data-item {
                padding: 3px 5px;
            }
        }
        
        /* Mobile styles (max-width: 768px) */
        @media screen and (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .mobile-message {
                display: block;
            }
            
            .info-panel {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                transform: translateY(-100%);
                z-index: 2000;
                height: 100vh;
                overflow-y: auto;
                padding: 60px 20px 20px 20px;
                box-sizing: border-box;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
            }
            
            .info-panel.mobile-visible {
                transform: translateY(0);
            }
            
            .data-inbox {
                position: fixed;
                top: auto;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-width: 100%;
                max-height: 85vh;
                border-radius: 8px 8px 0 0;
                transform: translateY(100%);
                z-index: 2000;
                padding: 20px;
                box-sizing: border-box;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            .data-inbox .panel-close-btn {
                right: 15px !important;
            }
            
            .data-inbox.mobile-visible {
                transform: translateY(0);
            }
            
            .instructions {
                display: none;
            }
            
            .arc-tooltip {
                font-size: 11px;
                padding: 6px 10px;
                max-width: 200px;
            }
            
            .selected-country {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .commodity-selector {
                margin-top: 15px;
                padding-top: 15px;
            }
            
            .commodity-selector label {
                font-size: 14px;
            }
            
            .commodity-selector input {
                padding: 10px;
                font-size: 14px;
            }
            
            .commodity-dropdown {
                max-height: 200px;
            }
            
            .commodity-option {
                padding: 6px;
                font-size: 11px;
            }
            
            .data-item {
                padding: 6px 8px;
                margin-bottom: 4px;
            }
            
            .commodity-name {
                font-size: 12px;
            }
            
            .source-country {
                font-size: 11px;
            }
            
            .impact-value {
                font-size: 11px;
            }
            
            .data-inbox h3 {
                font-size: 13px;
            }
            
            .section-stats {
                font-size: 11px;
            }
            
            .see-more-btn {
                padding: 6px 10px;
                font-size: 12px;
                margin: 10px 0;
            }
        }
        
        /* Very small mobile (max-width: 375px) */
        @media screen and (max-width: 375px) {
            .info-panel {
                padding: 55px 15px 15px 15px;
            }
            
            .data-inbox {
                padding: 15px;
                max-height: 90vh;
            }
            
            .selected-country {
                font-size: 14px;
            }
            
            .commodity-dropdown {
                max-height: 150px;
            }
            
            .data-item {
                padding: 5px 8px;
                margin-bottom: 3px;
            }
            
            .commodity-name {
                font-size: 13px;
            }
            
            .impact-value {
                font-size: 12px;
            }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            z-index: 1000;
        }
        
        .arc-tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            border: 1px solid #666;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10000;
            display: none;
            max-width: 250px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .arc-tooltip .commodity-label {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .arc-tooltip .route-label {
            color: #ccc;
            font-size: 11px;
            margin-bottom: 2px;
        }
        
        .arc-tooltip .impact-label {
            color: #4CAF50;
            font-family: monospace;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading globe and data...</div>
    
    <div id="globe-container"></div>
    
    <div id="arc-tooltip" class="arc-tooltip"></div>
    
    <!-- Mobile UI elements -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">☰ Info</button>
    <div class="mobile-overlay" id="mobile-overlay"></div>
    <div class="mobile-message">Tap countries to explore • Pinch to zoom</div>
    
    <div class="info-panel" id="info-panel">
        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #444;">
            <h2 style="margin: 0 0 8px 0; font-size: 20px; color: #fff;">Biodiversity impact of food consumption</h2>
            <a href="https://www.nature.com/articles/s43016-025-01224-w" target="_blank" style="color: #66ff66; text-decoration: none; font-size: 14px; display: block; margin-bottom: 6px;">View paper in Nature Food →</a>
            <a href="https://www.conservation.cam.ac.uk" target="_blank" style="color: #66ff66; text-decoration: none; font-size: 14px;">Cambridge Conservation Initiative →</a>
        </div>
        <div class="selected-country" id="selected-country">Click a country to explore</div>
        <div class="country-info" id="country-info">
            Country codes available: <span id="available-countries">Loading...</span>
        </div>
        <div class="commodity-selector" id="commodity-selector" style="display: none;">
            <label for="commodity-input">Filter by commodity:</label>
            <div style="position: relative;">
                <input type="text" id="commodity-input" placeholder="Type to search or select all..." autocomplete="off">
                <span class="commodity-clear" id="commodity-clear">&times;</span>
            </div>
            <div class="commodity-dropdown" id="commodity-dropdown"></div>
        </div>
    </div>

    <div class="instructions">
        Click countries to explore their food trade impacts. Arc colors range from <span style="color: #ff4444;">red</span> (high impact) to <span style="color: #44ff44;">green</span> (low impact).
        <br><br>
        <strong>What are LIFE scores?</strong><br>
        LIFE (Land-use Impact on Future Extinctions) measures biodiversity impact. The scores represent the fraction of species extinctions attributable to land-use change. Higher scores indicate greater contribution to global species extinction risk. <a href="https://royalsocietypublishing.org/doi/10.1098/rstb.2023.0327" target="_blank" style="color: #4CAF50;">Learn more about the LIFE methodology →</a>
        <br><br>
        <strong>Data:</strong> <span style="position: relative; display: inline-block;">
            <span style="cursor: help; text-decoration: underline; text-decoration-style: dotted;" 
                  onmouseover="document.getElementById('ibat-tooltip').style.display='block'" 
                  onmouseout="document.getElementById('ibat-tooltip').style.display='none'">CC-BY-SA license.</span>
            <div id="ibat-tooltip" style="display: none; position: absolute; bottom: 100%; left: 0; width: 350px; 
                 background: rgba(0, 0, 0, 0.95); color: #fff; padding: 12px; border-radius: 6px; 
                 border: 1px solid #444; font-size: 11px; line-height: 1.4; z-index: 10000; margin-bottom: 5px;">
                For commercial use of LIFE's underlying data (i.e. IUCN Red List) please contact the Integrated Biodiversity Assessment Tool (IBAT) at ibat@ibat-alliance.org. 
                <a href="https://www.ibat-alliance.org/" target="_blank" style="color: #4CAF50;">IBAT</a> is provided by BirdLife International, Conservation International, IUCN and UNEP-WCMC. 
                IBAT licenses access to global biodiversity data for commercial use, specifically The IUCN Red List of Threatened Species™, The World Database on Protected Areas, 
                and the World Database of Key Biodiversity Areas and derived data layers (STAR, RWR).
            </div>
        </span>.<br><i>Contact: <a href="https://anil.recoil.org" target="_blank" style="color: #4CAF50;">Anil Madhavapeddy</a> with queries.</i>
    </div>

    <div id="data-inbox" class="data-inbox" style="display: none;">
        <h3 id="data-inbox-header">Impact Data</h3>
        <div id="data-list"></div>
    </div>

    <script src="https://unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>
    <script>
        let globe;
        let countryData = [];
        let availableCountryCodes = new Set();
        let selectedCountry = null;
        let hoveredCountry = null;
        let selectedCommodity = '';  // Empty string means show all
        let impactData = {};
        let countryCoordinates = {};
        let currentArcs = [];
        let minImpact = Number.MAX_VALUE;
        let maxImpact = Number.MIN_VALUE;
        let isHoveringDataInbox = false;  // Track if mouse is over data inbox
        
        // Country code to full name mapping
        const countryNames = {
            'afg': 'Afghanistan', 'ago': 'Angola', 'alb': 'Albania', 'are': 'United Arab Emirates',
            'arg': 'Argentina', 'aus': 'Australia', 'aut': 'Austria', 'aze': 'Azerbaijan',
            'bdi': 'Burundi', 'bel': 'Belgium', 'ben': 'Benin', 'bfa': 'Burkina Faso',
            'bgd': 'Bangladesh', 'bgr': 'Bulgaria', 'bhr': 'Bahrain', 'bhs': 'Bahamas',
            'bih': 'Bosnia and Herzegovina', 'blr': 'Belarus', 'blz': 'Belize', 'bol': 'Bolivia',
            'bra': 'Brazil', 'brb': 'Barbados', 'btn': 'Bhutan', 'bwa': 'Botswana',
            'caf': 'Central African Republic', 'can': 'Canada', 'che': 'Switzerland', 'chl': 'Chile',
            'chn': 'China', 'civ': "Côte d'Ivoire", 'cmr': 'Cameroon', 'cod': 'Congo (DRC)',
            'cog': 'Congo', 'col': 'Colombia', 'com': 'Comoros', 'cpv': 'Cape Verde',
            'cri': 'Costa Rica', 'cub': 'Cuba', 'cyp': 'Cyprus', 'cze': 'Czech Republic',
            'deu': 'Germany', 'dji': 'Djibouti', 'dma': 'Dominica', 'dnk': 'Denmark',
            'dom': 'Dominican Republic', 'dza': 'Algeria', 'ecu': 'Ecuador', 'egy': 'Egypt',
            'eri': 'Eritrea', 'esp': 'Spain', 'est': 'Estonia', 'eth': 'Ethiopia',
            'fin': 'Finland', 'fji': 'Fiji', 'fra': 'France', 'fsm': 'Micronesia',
            'gab': 'Gabon', 'gbr': 'United Kingdom', 'geo': 'Georgia', 'gha': 'Ghana',
            'gin': 'Guinea', 'gmb': 'Gambia', 'gnb': 'Guinea-Bissau', 'gnq': 'Equatorial Guinea',
            'grc': 'Greece', 'grd': 'Grenada', 'gtm': 'Guatemala', 'guy': 'Guyana',
            'hkg': 'Hong Kong', 'hnd': 'Honduras', 'hrv': 'Croatia', 'hti': 'Haiti',
            'hun': 'Hungary', 'idn': 'Indonesia', 'ind': 'India', 'irl': 'Ireland',
            'irn': 'Iran', 'irq': 'Iraq', 'isl': 'Iceland', 'isr': 'Israel',
            'ita': 'Italy', 'jam': 'Jamaica', 'jor': 'Jordan', 'jpn': 'Japan',
            'kaz': 'Kazakhstan', 'ken': 'Kenya', 'kgz': 'Kyrgyzstan', 'khm': 'Cambodia',
            'kir': 'Kiribati', 'kna': 'Saint Kitts and Nevis', 'kor': 'South Korea', 'kwt': 'Kuwait',
            'lao': 'Laos', 'lbn': 'Lebanon', 'lbr': 'Liberia', 'lby': 'Libya',
            'lca': 'Saint Lucia', 'lka': 'Sri Lanka', 'lso': 'Lesotho', 'ltu': 'Lithuania',
            'lux': 'Luxembourg', 'lva': 'Latvia', 'mac': 'Macao', 'mar': 'Morocco',
            'mda': 'Moldova', 'mdg': 'Madagascar', 'mdv': 'Maldives', 'mex': 'Mexico',
            'mkd': 'North Macedonia', 'mli': 'Mali', 'mlt': 'Malta', 'mmr': 'Myanmar',
            'mne': 'Montenegro', 'mng': 'Mongolia', 'moz': 'Mozambique', 'mrt': 'Mauritania',
            'mus': 'Mauritius', 'mwi': 'Malawi', 'mys': 'Malaysia', 'nam': 'Namibia',
            'ncl': 'New Caledonia', 'ner': 'Niger', 'nga': 'Nigeria', 'nic': 'Nicaragua',
            'nld': 'Netherlands', 'nor': 'Norway', 'npl': 'Nepal', 'nru': 'Nauru',
            'nzl': 'New Zealand', 'omn': 'Oman', 'pak': 'Pakistan', 'pan': 'Panama',
            'per': 'Peru', 'phl': 'Philippines', 'png': 'Papua New Guinea', 'pol': 'Poland',
            'pri': 'Puerto Rico', 'prk': 'North Korea', 'prt': 'Portugal', 'pry': 'Paraguay',
            'pse': 'Palestine', 'pyf': 'French Polynesia', 'qat': 'Qatar', 'rou': 'Romania',
            'rus': 'Russia', 'rwa': 'Rwanda', 'sau': 'Saudi Arabia', 'sdn': 'Sudan',
            'sen': 'Senegal', 'sgp': 'Singapore', 'slb': 'Solomon Islands', 'sle': 'Sierra Leone',
            'slv': 'El Salvador', 'smr': 'San Marino', 'som': 'Somalia', 'srb': 'Serbia',
            'ssd': 'South Sudan', 'stp': 'São Tomé and Príncipe', 'sur': 'Suriname', 'svk': 'Slovakia',
            'svn': 'Slovenia', 'swe': 'Sweden', 'swz': 'Eswatini', 'syc': 'Seychelles',
            'syr': 'Syria', 'tcd': 'Chad', 'tgo': 'Togo', 'tha': 'Thailand',
            'tjk': 'Tajikistan', 'tkm': 'Turkmenistan', 'tls': 'Timor-Leste', 'ton': 'Tonga',
            'tto': 'Trinidad and Tobago', 'tun': 'Tunisia', 'tur': 'Turkey', 'tuv': 'Tuvalu',
            'twn': 'Taiwan', 'tza': 'Tanzania', 'uga': 'Uganda', 'ukr': 'Ukraine',
            'ury': 'Uruguay', 'usa': 'United States', 'uzb': 'Uzbekistan', 'vat': 'Vatican City',
            'vct': 'Saint Vincent and the Grenadines', 'ven': 'Venezuela', 'vgb': 'British Virgin Islands',
            'vir': 'U.S. Virgin Islands', 'vnm': 'Vietnam', 'vut': 'Vanuatu', 'wlf': 'Wallis and Futuna',
            'wsm': 'Samoa', 'yem': 'Yemen', 'zaf': 'South Africa', 'zmb': 'Zambia', 'zwe': 'Zimbabwe'
        };
        
        // Helper function to get country name from code
        function getCountryName(code) {
            if (!code) return '';
            const lowerCode = code.toLowerCase();
            return countryNames[lowerCode] || code.toUpperCase();
        }

        // Initialize globe
        function initGlobe() {
            // Check if Globe is available
            if (typeof Globe === 'undefined') {
                console.error('Globe.gl library not loaded yet');
                setTimeout(initGlobe, 100); // Retry after 100ms
                return;
            }
            
            // Adjust settings for mobile
            const isMobile = window.innerWidth <= 768;
            const isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
            
            globe = Globe()
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
                .backgroundColor('rgba(0,0,0,0)')
                .showAtmosphere(true)
                .atmosphereColor('lightblue')
                .atmosphereAltitude(isMobile ? 0.15 : 0.25)
                .arcsData([])
                .arcColor(() => 'rgba(0, 255, 255, 0.9)')
                .arcDashLength(1)     // Solid lines - no dashes
                .arcDashGap(0)        // No gaps for solid appearance
                .arcDashAnimateTime(0) // No animation
                .arcStroke(arc => {
                    // Vary line thickness based on impact
                    const rank = arc.rank || 999;
                    if (rank <= 10) return 0.5;      // Top 10 thicker
                    if (rank <= 30) return 0.3;      // Top 30 medium
                    return 0.2;                       // Rest thinner
                })
                .arcAltitude(arc => {
                    // Special case for New Zealand routes (NZL country code)
                    const isNZRoute = arc.sourceCountry?.toLowerCase() === 'nzl' || 
                                     arc.targetCountry?.toLowerCase() === 'nzl';
                    
                    // Check if it's a route to/from NZ and Europe/UK (very long distance)
                    const isNZEuropeRoute = isNZRoute && (
                        arc.sourceCountry?.toLowerCase() === 'gbr' || 
                        arc.targetCountry?.toLowerCase() === 'gbr' ||
                        (Math.abs(arc.startLng) < 30 && arc.startLat > 35 && arc.startLat < 70) || // Europe region
                        (Math.abs(arc.endLng) < 30 && arc.endLat > 35 && arc.endLat < 70)
                    );
                    
                    if (isNZEuropeRoute) {
                        // Force very high altitude for NZ-Europe routes
                        return 0.6;
                    }
                    
                    // Calculate distance between points to adjust altitude
                    const dx = Math.abs(arc.startLng - arc.endLng);
                    const dy = Math.abs(arc.startLat - arc.endLat);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // More aggressive altitude scaling for longer distances
                    // Using exponential growth to ensure long arcs don't intersect Earth
                    const distanceRatio = Math.min(distance / 180, 1); // Normalize to 0-1
                    // Exponential curve: starts at 0.1, grows to 0.5 for max distance
                    const baseAltitude = 0.1 + (Math.pow(distanceRatio, 1.5) * 0.4);
                    
                    // Additional boost for very long distances (trans-oceanic routes)
                    const longDistanceBoost = distance > 120 ? (distance - 120) / 200 * 0.3 : 0;
                    
                    // Extra boost for New Zealand routes even if not to Europe
                    const nzBoost = isNZRoute ? 0.25 : 0;
                    
                    // Add small offset based on curveOffset to distinguish multiple arcs
                    const multiArcOffset = (arc.curveOffset || 0) * 0.05;
                    
                    // Vary by rank for visual hierarchy
                    const rank = arc.rank || 999;
                    let rankMultiplier = 1.0;
                    if (rank <= 10) rankMultiplier = 1.1;      // Top 10 slightly higher
                    else if (rank <= 30) rankMultiplier = 1.0; // Top 30 medium
                    else rankMultiplier = 0.9;                  // Rest slightly lower
                    
                    return (baseAltitude + longDistanceBoost + nzBoost + multiArcOffset) * rankMultiplier;
                })
                .arcDashLength(1)     // Solid lines - no dashes
                .arcDashGap(0)        // No gaps for solid appearance
                .arcDashAnimateTime(0) // No animation
                .arcColor(d => getArcColor(d))
                .arcsTransitionDuration(600)
                .onArcHover(arc => {
                    // Don't handle arc hover if we're hovering over the data inbox
                    if (isHoveringDataInbox) {
                        return;
                    }
                    
                    const tooltip = document.getElementById('arc-tooltip');
                    
                    if (arc && arc.rank <= 30) {  // Only handle hover for top 30 routes
                        // Highlight the hovered arc
                        const arcs = globe.arcsData();
                        arcs.forEach(a => {
                            a.highlighted = a === arc;
                        });
                        globe.arcsData(arcs);
                        
                        // Determine impact category and color
                        const impactRatio = arc.impact / maxImpact;
                        let borderColor, labelColor;
                        if (impactRatio > 0.7) {
                            // High impact - red
                            borderColor = '#ff4444';
                            labelColor = '#ff6666';
                        } else if (impactRatio > 0.3) {
                            // Medium impact - orange
                            borderColor = '#ffaa44';
                            labelColor = '#ffbb66';
                        } else {
                            // Low impact - green
                            borderColor = '#44ff44';
                            labelColor = '#66ff66';
                        }
                        
                        // Show tooltip with appropriate color
                        const sourceCountryName = getCountryName(arc.sourceCountry);
                        const targetCountryName = getCountryName(arc.targetCountry);
                        tooltip.innerHTML = `
                            <div class="commodity-label" style="color: ${labelColor}">${arc.commodity}</div>
                            <div class="route-label">${sourceCountryName} → ${targetCountryName}</div>
                            <div class="impact-label">Impact: ${arc.impact.toExponential(2)}</div>
                        `;
                        tooltip.style.borderColor = borderColor;
                        tooltip.style.boxShadow = `0 2px 8px ${borderColor}66`; // Add transparency to shadow
                        tooltip.style.display = 'block';
                        
                        // Highlighting only - no scrolling
                        scrollToImpactItem(arc);
                    } else {
                        // Remove highlight
                        const arcs = globe.arcsData();
                        arcs.forEach(a => {
                            a.highlighted = false;
                        });
                        globe.arcsData(arcs);
                        
                        // Hide tooltip
                        tooltip.style.display = 'none';
                        
                        // Clear all data panel highlights when not hovering any arc
                        clearAllHighlights();
                    }
                })
                .htmlElementsData([])
                .htmlElement(d => {
                    const el = document.createElement('div');
                    el.innerHTML = d.country;
                    el.style.color = 'white';
                    el.style.fontSize = '11px';
                    el.style.fontFamily = 'Arial, sans-serif';
                    el.style.fontWeight = 'bold';
                    el.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                    el.style.pointerEvents = 'none';
                    return el;
                });

            globe(document.getElementById('globe-container'));
            
            // Center on Europe by default (longitude: 10, latitude: 45)
            globe.pointOfView({ lat: 45, lng: 10, altitude: 2.0 });

            // Load country polygons data
            fetch('//raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson')
                .then(res => res.json())
                .then(countries => {
                    setupCountryInteraction(countries);
                    extractCountryCoordinates(countries);
                })
                .catch(err => {
                    console.error('Error loading country data:', err);
                    document.getElementById('loading').textContent = 'Error loading country data';
                });
        }

        // Load available country codes from the local countries.json file
        async function loadAvailableCountries() {
            try {
                // Load from local countries.json file
                const response = await fetch('countries.json');
                if (response.ok) {
                    const countries = await response.json();
                    availableCountryCodes = new Set(countries);
                    console.log(`Loaded ${countries.length} available countries from countries.json:`, countries);
                } else {
                    console.log('countries.json not found, using fallback country list');
                    // Fallback: predefined list based on the SPEC.md information
                    availableCountryCodes = new Set([
                        'afg', 'ago', 'alb', 'are', 'arg', 'aus', 'aut', 'aze', 'bdi', 'bel', 'ben', 'bfa', 'bgd', 'bgr', 'bhr', 'bhs', 'bih', 'blr', 'blz', 'bol', 'bra', 'brb', 'btn', 'bwa', 'caf', 'can', 'che', 'chl', 'chn', 'civ', 'cmr', 'cod', 'cog', 'col', 'com', 'cpv', 'cri', 'cub', 'cyp', 'deu', 'dji', 'dma', 'dnk', 'dom', 'dza', 'ecu', 'egy', 'esp', 'est', 'eth', 'fin', 'fji', 'fra', 'fsm', 'gab', 'gbr', 'geo', 'gha', 'gin', 'gmb', 'gnb', 'grc', 'grd', 'gtm', 'guy', 'hkg', 'hnd', 'hrv', 'hti', 'hun', 'idn', 'ind', 'irl', 'irn', 'irq', 'isl', 'isr', 'ita', 'jam', 'jor', 'jpn', 'kaz', 'ken', 'kgz', 'khm', 'kir', 'kna', 'kor', 'kwt', 'lao', 'lbn', 'lbr', 'lby', 'lca', 'lka', 'lso', 'ltu', 'lux', 'lva', 'mac', 'mar', 'mdg', 'mdv', 'mex', 'mkd', 'mli', 'mlt', 'mmr', 'mne', 'mng', 'moz', 'mrt', 'mus', 'mwi', 'mys', 'nam', 'ncl', 'ner', 'nga', 'nic', 'nld', 'nor', 'npl', 'nru', 'nzl', 'omn', 'pan', 'per', 'phl', 'png', 'pol', 'prk', 'prt', 'pyf', 'qat', 'rou', 'rus', 'rwa', 'sau', 'sdn', 'sen', 'slb', 'sle', 'slv', 'srb', 'ssd', 'stp', 'sur', 'svk', 'svn', 'swe', 'swz', 'syc', 'syr', 'tcd', 'tgo', 'tha', 'tjk', 'tkm', 'tls', 'tto', 'tun', 'tur', 'tza', 'uga', 'ukr', 'ury', 'usa', 'uzb', 'vct', 'ven', 'vnm', 'vut', 'wsm', 'yem', 'zaf', 'zmb', 'zwe'
                    ]);
                }
                
                document.getElementById('available-countries').textContent = `${availableCountryCodes.size} countries`;
            } catch (error) {
                console.error('Error loading country codes:', error);
                document.getElementById('available-countries').textContent = 'Error loading data';
            }
        }

        // Setup country interaction
        function setupCountryInteraction(countries) {
            countryData = countries.features;

            globe
                .polygonsData(countries.features)
                .polygonCapColor(feat => {
                    const countryCode = getCountryCode(feat);
                    
                    // Selected country (target) gets gold highlight
                    if (selectedCountry === countryCode) {
                        return 'rgba(255, 215, 0, 0.6)'; // Gold for selected target
                    } 
                    
                    // Check if this country is a source in current arcs
                    if (selectedCountry && currentArcs.length > 0) {
                        const sourceArc = currentArcs.find(arc => 
                            arc.sourceCountry.toLowerCase() === countryCode.toLowerCase()
                        );
                        if (sourceArc) {
                            // Color source countries based on their impact (matching arc colors)
                            const impactRatio = sourceArc.impact / maxImpact;
                            let r, g, b;
                            
                            if (impactRatio > 0.7) {
                                // High impact - red
                                r = 255; g = 68; b = 68;
                            } else if (impactRatio > 0.3) {
                                // Medium impact - orange
                                r = 255; g = 170; b = 68;
                            } else {
                                // Low impact - green
                                r = 68; g = 255; b = 68;
                            }
                            
                            // Use lower opacity for source countries
                            return `rgba(${r}, ${g}, ${b}, 0.4)`;
                        }
                    }
                    
                    // Hover effect takes precedence over other states
                    if (hoveredCountry === countryCode) {
                        return 'rgba(100, 180, 255, 0.6)'; // Light blue for hover
                    } 
                    
                    // Default colors for non-involved countries
                    if (availableCountryCodes.has(countryCode)) {
                        return 'rgba(76, 175, 80, 0.3)'; // Dimmer green for available countries
                    } else {
                        return 'rgba(100, 100, 100, 0.3)'; // Gray for unavailable
                    }
                })
                .polygonSideColor(() => 'rgba(0, 100, 0, 0.05)')
                .polygonStrokeColor(() => '#111')
                .polygonAltitude(feat => {
                    const countryCode = getCountryCode(feat);
                    if (selectedCountry === countryCode) {
                        return 0.02;
                    } else if (hoveredCountry === countryCode) {
                        return 0.015;
                    } else {
                        return 0.01;
                    }
                })
                .polygonCapCurvatureResolution(4)
                .onPolygonClick((polygon) => {
                    const countryCode = getCountryCode(polygon);
                    
                    if (availableCountryCodes.has(countryCode)) {
                        // On mobile, if clicking the same country, toggle the data panel
                        if (window.innerWidth <= 768 && selectedCountry === countryCode) {
                            const dataInbox = document.getElementById('data-inbox');
                            const isVisible = dataInbox.classList.contains('mobile-visible');
                            
                            if (!isVisible && dataInbox.style.display !== 'none') {
                                // Re-show the data panel
                                if (window.showMobilePanel) {
                                    window.showMobilePanel(dataInbox);
                                }
                            } else {
                                // Close the panel if it's open
                                window.closeMobilePanel();
                            }
                        } else {
                            // Select new country
                            selectCountry(countryCode);
                        }
                    } else {
                        console.log(`Country ${countryCode} not available in dataset`);
                        const countryName = getCountryName(countryCode);
                        document.getElementById('selected-country').textContent = 
                            `${countryName} - No data available`;
                        
                        // Clear the data panel
                        selectedCountry = null;
                        currentArcs = [];
                        globe.arcsData([]);
                        globe.htmlElementsData([]);
                        
                        // Hide or clear the data inbox
                        const dataInbox = document.getElementById('data-inbox');
                        dataInbox.style.display = 'none';
                        
                        // Clear commodity selector
                        const commoditySelector = document.getElementById('commodity-selector');
                        if (commoditySelector) {
                            commoditySelector.style.display = 'none';
                        }
                        
                        // Re-render polygons to clear highlighting
                        globe.polygonsData(countryData);
                    }
                })
                .onPolygonHover((polygon) => {
                    // Don't update hover state if we're hovering over the data inbox
                    if (isHoveringDataInbox) {
                        return;
                    }
                    
                    if (polygon) {
                        const countryCode = getCountryCode(polygon);
                        hoveredCountry = countryCode;
                        document.getElementById('globe-container').style.cursor = 
                            availableCountryCodes.has(countryCode) ? 'pointer' : 'default';
                        
                        // Show country name on hover in top-left panel only if no selection
                        if (!selectedCountry) {
                            const countryName = getCountryName(countryCode);
                            document.getElementById('selected-country').textContent = countryName;
                        }
                        
                        // Always re-render polygons to show hover effect
                        globe.polygonsData(countryData);
                    } else {
                        // Don't clear hover state if we're hovering over the data inbox
                        if (!isHoveringDataInbox) {
                            hoveredCountry = null;
                            document.getElementById('globe-container').style.cursor = 'default';
                            
                            // Reset display when not hovering only if no selection
                            if (!selectedCountry) {
                                document.getElementById('selected-country').textContent = 'Click a country to explore';
                            }
                        }
                        
                        // Always re-render polygons to remove hover effect
                        globe.polygonsData(countryData);
                    }
                });

            document.getElementById('loading').style.display = 'none';
        }

        // Extract country coordinates from geojson features
        function extractCountryCoordinates(countries) {
            countries.features.forEach(feature => {
                const countryCode = getCountryCode(feature);
                if (countryCode && feature.geometry) {
                    // Calculate centroid for the country
                    const coords = getCentroid(feature.geometry);
                    if (coords) {
                        countryCoordinates[countryCode] = {
                            lat: coords[1],
                            lng: coords[0]
                        };
                        // Also store uppercase version for matching
                        countryCoordinates[countryCode.toUpperCase()] = {
                            lat: coords[1],
                            lng: coords[0]
                        };
                    }
                }
            });
            console.log(`Extracted coordinates for ${Object.keys(countryCoordinates).length} countries`);
            console.log(`Sample coordinates:`, Object.entries(countryCoordinates).slice(0, 5));
        }

        // Calculate centroid of a geometry
        function getCentroid(geometry) {
            if (geometry.type === 'Polygon') {
                return getPolygonCentroid(geometry.coordinates[0]);
            } else if (geometry.type === 'MultiPolygon') {
                // Use the largest polygon's centroid
                let largestArea = 0;
                let largestPolygon = null;
                geometry.coordinates.forEach(polygon => {
                    const area = getPolygonArea(polygon[0]);
                    if (area > largestArea) {
                        largestArea = area;
                        largestPolygon = polygon[0];
                    }
                });
                return largestPolygon ? getPolygonCentroid(largestPolygon) : null;
            }
            return null;
        }

        // Calculate polygon centroid
        function getPolygonCentroid(coordinates) {
            let x = 0, y = 0;
            coordinates.forEach(coord => {
                x += coord[0];
                y += coord[1];
            });
            return [x / coordinates.length, y / coordinates.length];
        }

        // Calculate polygon area (rough approximation)
        function getPolygonArea(coordinates) {
            let area = 0;
            for (let i = 0; i < coordinates.length - 1; i++) {
                area += coordinates[i][0] * coordinates[i + 1][1];
                area -= coordinates[i + 1][0] * coordinates[i][1];
            }
            return Math.abs(area) / 2;
        }

        // Extract country code from geojson feature
        function getCountryCode(feature) {
            // Common property names for country codes in geojson
            return (feature.properties.ISO_A3 || 
                   feature.properties.iso_a3 || 
                   feature.properties.ADM0_A3 ||
                   feature.properties.ADMIN ||
                   feature.id || 
                   '').toLowerCase();
        }

        // Load impact data for a country
        async function loadImpactData(countryCode) {
            try {
                const response = await fetch(`${countryCode}/impact_paths.json`);
                if (response.ok) {
                    const data = await response.json();
                    console.log(`Loaded impact data for ${countryCode}:`, Object.keys(data).length, 'commodities');
                    return data;
                } else {
                    console.warn(`No impact data found for ${countryCode}`);
                    return {};
                }
            } catch (error) {
                console.error(`Error loading impact data for ${countryCode}:`, error);
                return {};
            }
        }

        // Get color for arc based on impact value
        function getArcColor(arc) {
            const impact = arc.impact;
            const rank = arc.rank || 999; // rank will be set in createArcsFromImpactData
            
            if (minImpact === maxImpact) return 'rgba(0, 255, 255, 0.8)';
            
            // Use consistent categorization with sidebar
            // High impact: > 70% of max, Medium: 30-70%, Low: < 30%
            const impactRatio = impact / maxImpact;
            
            // Calculate opacity based on both impact and rank
            let opacity;
            if (arc.highlighted) {
                // Highlighted arc gets full opacity
                opacity = 1.0;
            } else if (rank <= 30) {
                // Top 30: higher opacity range (0.3 to 0.9)
                const normalized = (impact - minImpact) / (maxImpact - minImpact);
                opacity = 0.3 + (normalized * 0.6);
            } else {
                // Beyond top 30: much lower opacity range (0.02 to 0.15)
                const normalized = (impact - minImpact) / (maxImpact - minImpact);
                opacity = 0.02 + (normalized * 0.13);
            }
            
            // Color based on impact category (matching sidebar)
            // Highlighted arcs get brighter colors
            const brightness = arc.highlighted ? 1.2 : 1.0;
            
            if (impactRatio > 0.7) {
                // High impact - red (matching .high-impact border color #ff4444)
                const r = Math.min(255, Math.floor(255 * brightness));
                const g = Math.min(255, Math.floor(68 * brightness));
                const b = Math.min(255, Math.floor(68 * brightness));
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            } else if (impactRatio > 0.3) {
                // Medium impact - orange/yellow (matching .medium-impact border color #ffaa44)
                const r = Math.min(255, Math.floor(255 * brightness));
                const g = Math.min(255, Math.floor(170 * brightness));
                const b = Math.min(255, Math.floor(68 * brightness));
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            } else {
                // Low impact - green (matching .low-impact border color #44ff44)
                const r = Math.min(255, Math.floor(68 * brightness));
                const g = Math.min(255, Math.floor(255 * brightness));
                const b = Math.min(255, Math.floor(68 * brightness));
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
        }
        
        // Track highlight timeouts to prevent overlapping
        let highlightTimeouts = new Map();
        
        // Clear all highlights from data panel
        function clearAllHighlights() {
            highlightTimeouts.forEach((timeouts, item) => {
                timeouts.forEach(timeout => clearTimeout(timeout));
                // Reset styles immediately
                item.style.borderLeftColor = '';
                const impactValue = item.querySelector('.impact-value');
                if (impactValue) {
                    impactValue.style.color = '';
                    impactValue.style.transform = '';
                }
            });
            highlightTimeouts.clear();
        }
        
        // Scroll to impact item in the data panel
        function scrollToImpactItem(arc) {
            // First, clear all existing highlights and timeouts
            clearAllHighlights();
            
            // Find the corresponding data item
            const dataItems = document.querySelectorAll('.data-item');
            let targetItem = null;
            
            dataItems.forEach(item => {
                const commodityName = item.querySelector('.commodity-name')?.textContent;
                const sourceCountry = item.querySelector('.source-country')?.textContent;
                
                if (commodityName === arc.commodity) {
                    // Check if it's the right source country (for international) or domestic
                    if (sourceCountry && sourceCountry.includes(getCountryName(arc.sourceCountry))) {
                        targetItem = item;
                    } else if (!sourceCountry && arc.sourceCountry.toLowerCase() === selectedCountry.toLowerCase()) {
                        targetItem = item;
                    }
                }
            });
            
            if (targetItem) {
                // Only proceed if the item is not collapsed (don't auto-expand)
                if (!targetItem.classList.contains('collapsed')) {
                    // Highlight the item by changing the left border color to bright cyan
                    targetItem.style.transition = 'border-left-color 0.3s';
                    targetItem.style.borderLeftColor = '#00ffff';  // Bright cyan to really pop
                    
                    const impactValue = targetItem.querySelector('.impact-value');
                    if (impactValue) {
                        impactValue.style.transition = 'color 0.3s, transform 0.3s';
                        impactValue.style.color = '#00ffff';  // Bright cyan
                        impactValue.style.transform = 'scale(1.2)';  // Make it slightly bigger instead of bold
                    }
                    
                    // Store timeouts for this item
                    const timeouts = [];
                    
                    // Remove impact value highlight after a moment
                    if (impactValue) {
                        timeouts.push(setTimeout(() => {
                            impactValue.style.color = '';
                            impactValue.style.transform = '';
                        }, 2000));
                    }
                    
                    // Remove border highlight after a moment
                    timeouts.push(setTimeout(() => {
                        targetItem.style.borderLeftColor = '';
                        highlightTimeouts.delete(targetItem);
                    }, 2000));
                    
                    highlightTimeouts.set(targetItem, timeouts);
                }
            }
        }

        // Update data inbox with current arc information
        function updateDataInbox(arcs) {
            const dataInbox = document.getElementById('data-inbox');
            const dataList = document.getElementById('data-list');
            
            if (arcs.length === 0 && !selectedCountry) {
                dataInbox.style.display = 'none';
                return;
            }
            
            // Split arcs into domestic and international
            const domesticArcs = [];
            const internationalArcs = [];
            
            arcs.forEach(arc => {
                if (arc.sourceCountry.toLowerCase() === selectedCountry.toLowerCase()) {
                    domesticArcs.push(arc);
                } else {
                    internationalArcs.push(arc);
                }
            });
            
            // Create a combined sorted list for percentile calculation
            const allArcsSorted = [...arcs].sort((a, b) => b.impact - a.impact);
            const totalItems = allArcsSorted.length;
            
            // Create a map of impact value to percentile
            const impactToPercentile = new Map();
            allArcsSorted.forEach((arc, index) => {
                const percentile = Math.round(((index + 1) / totalItems) * 100);
                impactToPercentile.set(arc.impact, percentile);
            });
            
            // Calculate total impacts for summaries
            const domesticTotal = domesticArcs.reduce((sum, arc) => sum + arc.impact, 0);
            const internationalTotal = internationalArcs.reduce((sum, arc) => sum + arc.impact, 0);
            const totalImpact = domesticTotal + internationalTotal;
            
            // Find max and min impact for scaling bars and variance calculation
            const allArcs = [...domesticArcs, ...internationalArcs];
            const localMaxImpact = Math.max(...allArcs.map(arc => arc.impact));
            const localMinImpact = Math.min(...allArcs.map(arc => arc.impact));
            
            // Calculate spatial variance (orders of magnitude difference)
            const ordersOfMagnitude = localMaxImpact > 0 && localMinImpact > 0 ? 
                Math.log10(localMaxImpact / localMinImpact).toFixed(1) : 0;
            
            dataInbox.style.display = 'block';
            dataList.innerHTML = '';
            
            // Update the header with country name and variance info
            const header = document.getElementById('data-inbox-header');
            const countryName = getCountryName(selectedCountry);
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile: Always show country name prominently
                if (selectedCommodity) {
                    header.innerHTML = `
                        <div class="main-title">${countryName}</div>
                        <div style="font-size: 11px; color: #4CAF50; margin-top: 2px;">${selectedCommodity}</div>
                        <div class="variance-info">
                            <span class="variance-value">${ordersOfMagnitude}</span> orders of magnitude variance
                        </div>
                    `;
                } else {
                    header.innerHTML = `
                        <div class="main-title">${countryName}</div>
                        <div style="font-size: 11px; color: #aaa; margin-top: 2px;">All commodities</div>
                    `;
                }
            } else {
                // Desktop: Original layout
                if (selectedCommodity) {
                    header.innerHTML = `
                        <div class="main-title">Impact Data - ${selectedCommodity}</div>
                        <div class="variance-info">
                            Spatial variance: <span class="variance-value">${ordersOfMagnitude}</span> orders of magnitude
                            (${localMinImpact.toExponential(1)} to ${localMaxImpact.toExponential(1)})
                        </div>
                    `;
                } else {
                    header.innerHTML = '<div class="main-title">Impact Data</div>';
                }
            }
            
            // Add international section first if there are international impacts
            if (internationalArcs.length > 0) {
                const internationalHeader = document.createElement('h3');
                const internationalPercent = totalImpact > 0 ? ((internationalTotal / totalImpact) * 100).toFixed(1) : 0;
                internationalHeader.innerHTML = `
                    <span>International</span>
                    <span class="section-stats">${internationalPercent}% of total</span>
                `;
                internationalHeader.style.marginTop = '0';
                dataList.appendChild(internationalHeader);
                
                const showLimit = 15;
                const needsExpansion = internationalArcs.length > showLimit;
                
                internationalArcs.forEach((arc, index) => {
                    const impactRatio = arc.impact / maxImpact;
                    const impactCategory = impactRatio > 0.7 ? 'high-impact' : 
                                         impactRatio > 0.3 ? 'medium-impact' : 'low-impact';
                    const impactValueClass = impactRatio > 0.7 ? 'high-impact-value' : 
                                            impactRatio > 0.3 ? 'medium-impact-value' : 'low-impact-value';
                    
                    const barWidth = (arc.impact / localMaxImpact) * 100;
                    
                    // Get percentile from the combined country ranking
                    const percentile = impactToPercentile.get(arc.impact) || 100;
                    
                    const dataItem = document.createElement('div');
                    const isCollapsed = needsExpansion && index >= showLimit;
                    dataItem.className = `data-item ${impactCategory} international-item ${isCollapsed ? 'collapsed' : ''}`;
                    dataItem.title = `Hover to view ${getCountryName(arc.sourceCountry)} on globe`;
                    dataItem.innerHTML = `
                        <div class="impact-bar" style="width: ${barWidth}%"></div>
                        <div class="data-item-content">
                            <div class="data-item-info">
                                <div class="commodity-name" title="Click to filter to ${arc.commodity}">${arc.commodity}</div>
                                <div class="source-country" data-country="${arc.sourceCountry}">From: ${getCountryName(arc.sourceCountry)}</div>
                            </div>
                            <div class="impact-value ${impactValueClass}">
                                <span class="impact-score">${arc.impact.toExponential(2)}</span>
                                <span class="impact-rank">Top ${percentile}%</span>
                            </div>
                        </div>
                    `;
                    
                    // Add click handler to commodity name if showing all commodities
                    if (!selectedCommodity) {
                        const commodityEl = dataItem.querySelector('.commodity-name');
                        if (commodityEl) {
                            commodityEl.addEventListener('click', (e) => {
                                e.stopPropagation();
                                filterToCommodity(arc.commodity);
                            });
                        }
                    }
                    
                    // Add hover handler to entire data item for international entries
                    dataItem.addEventListener('mouseenter', (e) => {
                        const countryCode = arc.sourceCountry;
                        const coords = countryCoordinates[countryCode] || countryCoordinates[countryCode.toUpperCase()];
                        if (coords) {
                            // Smoothly rotate globe to show the source country
                            globe.pointOfView({ lat: coords.lat, lng: coords.lng, altitude: 1.5 }, 1000);
                        }
                    });
                    
                    dataList.appendChild(dataItem);
                });
                
                // Add "see more/less" button if needed
                if (needsExpansion) {
                    const seeMoreBtn = document.createElement('div');
                    seeMoreBtn.className = 'see-more-btn';
                    seeMoreBtn.textContent = `See ${internationalArcs.length - showLimit} more`;
                    seeMoreBtn.dataset.expanded = 'false';
                    seeMoreBtn.dataset.section = 'international';
                    seeMoreBtn.onclick = function() {
                        const isExpanded = this.dataset.expanded === 'true';
                        const items = document.querySelectorAll('.international-item');
                        items.forEach((item, index) => {
                            if (index >= showLimit) {
                                item.classList.toggle('collapsed');
                            }
                        });
                        this.dataset.expanded = !isExpanded;
                        this.textContent = isExpanded ? `See ${internationalArcs.length - showLimit} more` : 'See less';
                    };
                    dataList.appendChild(seeMoreBtn);
                }
            }
            
            // Add domestic section after international if there are domestic impacts
            if (domesticArcs.length > 0) {
                const domesticHeader = document.createElement('h3');
                const domesticPercent = totalImpact > 0 ? ((domesticTotal / totalImpact) * 100).toFixed(1) : 0;
                domesticHeader.innerHTML = `
                    <span>Domestic</span>
                    <span class="section-stats">${domesticPercent}% of total</span>
                `;
                domesticHeader.style.marginTop = internationalArcs.length > 0 ? '15px' : '0';
                dataList.appendChild(domesticHeader);
                
                const showLimit = 15;
                const needsExpansion = domesticArcs.length > showLimit;
                
                domesticArcs.forEach((arc, index) => {
                    const impactRatio = arc.impact / maxImpact;
                    const impactCategory = impactRatio > 0.7 ? 'high-impact' : 
                                         impactRatio > 0.3 ? 'medium-impact' : 'low-impact';
                    const impactValueClass = impactRatio > 0.7 ? 'high-impact-value' : 
                                            impactRatio > 0.3 ? 'medium-impact-value' : 'low-impact-value';
                    
                    const barWidth = (arc.impact / localMaxImpact) * 100;
                    
                    // Get percentile from the combined country ranking
                    const percentile = impactToPercentile.get(arc.impact) || 100;
                    
                    const dataItem = document.createElement('div');
                    const isCollapsed = needsExpansion && index >= showLimit;
                    dataItem.className = `data-item ${impactCategory} domestic-item ${isCollapsed ? 'collapsed' : ''}`;
                    dataItem.innerHTML = `
                        <div class="impact-bar" style="width: ${barWidth}%"></div>
                        <div class="data-item-content">
                            <div class="commodity-name" title="Click to filter to ${arc.commodity}">${arc.commodity}</div>
                            <div class="impact-value ${impactValueClass}">
                                <span class="impact-score">${arc.impact.toExponential(2)}</span>
                                <span class="impact-rank">Top ${percentile}%</span>
                            </div>
                        </div>
                    `;
                    
                    // Add click handler to commodity name if showing all commodities
                    if (!selectedCommodity) {
                        const commodityEl = dataItem.querySelector('.commodity-name');
                        if (commodityEl) {
                            commodityEl.addEventListener('click', (e) => {
                                e.stopPropagation();
                                filterToCommodity(arc.commodity);
                            });
                        }
                    }
                    
                    dataList.appendChild(dataItem);
                });
                
                // Add "see more/less" button if needed
                if (needsExpansion) {
                    const seeMoreBtn = document.createElement('div');
                    seeMoreBtn.className = 'see-more-btn';
                    seeMoreBtn.textContent = `See ${domesticArcs.length - showLimit} more`;
                    seeMoreBtn.dataset.expanded = 'false';
                    seeMoreBtn.dataset.section = 'domestic';
                    seeMoreBtn.onclick = function() {
                        const isExpanded = this.dataset.expanded === 'true';
                        const items = document.querySelectorAll('.domestic-item');
                        items.forEach((item, index) => {
                            if (index >= showLimit) {
                                item.classList.toggle('collapsed');
                            }
                        });
                        this.dataset.expanded = !isExpanded;
                        this.textContent = isExpanded ? `See ${domesticArcs.length - showLimit} more` : 'See less';
                    };
                    dataList.appendChild(seeMoreBtn);
                }
            }
        }

        // Create arcs from impact data
        function createArcsFromImpactData(targetCountryCode, impactData) {
            const arcs = [];
            
            console.log(`Creating arcs for target country: ${targetCountryCode}`);
            console.log(`Selected commodity filter: ${selectedCommodity || 'All'}`);
            console.log(`Available country coordinates: ${Object.keys(countryCoordinates).length}`);
            console.log(`Impact data commodities: ${Object.keys(impactData).length}`);
            
            const targetCoords = countryCoordinates[targetCountryCode] || countryCoordinates[targetCountryCode.toUpperCase()];
            if (!targetCoords) {
                console.warn(`No coordinates found for target country: ${targetCountryCode}`);
                console.log(`Available coordinates:`, Object.keys(countryCoordinates).slice(0, 10));
                return { arcs: [], totalRoutes: 0 };
            }
            
            console.log(`Target coordinates for ${targetCountryCode}:`, targetCoords);

            let validArcsCount = 0;
            let totalSourcesChecked = 0;
            let totalTradeRoutes = 0;
            
            // Reset min/max impact values
            minImpact = Number.MAX_VALUE;
            maxImpact = Number.MIN_VALUE;

            // First pass: collect all valid arcs and find min/max impact
            Object.entries(impactData).forEach(([commodity, sources]) => {
                // Filter by selected commodity if one is selected
                if (selectedCommodity && commodity !== selectedCommodity) {
                    return;  // Skip this commodity if it doesn't match the filter
                }
                Object.entries(sources).forEach(([sourceCountryCode, impactValue]) => {
                    totalSourcesChecked++;
                    const sourceCoords = countryCoordinates[sourceCountryCode] || countryCoordinates[sourceCountryCode.toUpperCase()];
                    
                    if (sourceCoords && impactValue > 0) {
                        validArcsCount++;
                        totalTradeRoutes++;  // Count total trade routes
                        minImpact = Math.min(minImpact, impactValue);
                        maxImpact = Math.max(maxImpact, impactValue);
                        
                        // Create arc from source to target
                        // Normalize longitude to handle dateline crossing
                        let startLng = sourceCoords.lng;
                        let endLng = targetCoords.lng;
                        
                        // Ensure we take the shortest path around the globe
                        const lngDiff = endLng - startLng;
                        if (Math.abs(lngDiff) > 180) {
                            if (lngDiff > 0) {
                                startLng += 360;
                            } else {
                                endLng += 360;
                            }
                        }
                        
                        arcs.push({
                            startLat: sourceCoords.lat,
                            startLng: startLng,
                            endLat: targetCoords.lat,
                            endLng: endLng,
                            commodity: commodity,
                            impact: impactValue,
                            sourceCountry: sourceCountryCode,
                            targetCountry: targetCountryCode
                        });
                        
                        // Log first few valid arcs for debugging
                        if (validArcsCount <= 3) {
                            console.log(`Arc ${validArcsCount}: ${sourceCountryCode} -> ${targetCountryCode} (${commodity}: ${impactValue})`);
                        }
                    } else if (!sourceCoords) {
                        // Log missing coordinates for first few cases
                        if (totalSourcesChecked <= 5) {
                            console.log(`Missing coordinates for source: ${sourceCountryCode}`);
                        }
                    }
                });
            });
            
            console.log(`Total sources checked: ${totalSourcesChecked}, Valid arcs created: ${validArcsCount}`);
            console.log(`Impact range: ${minImpact} to ${maxImpact}`);
            
            // Sort arcs by impact value (highest first) and add rank
            arcs.sort((a, b) => b.impact - a.impact);
            
            // Limit arcs based on device - fewer on mobile for better performance
            const isMobile = window.innerWidth <= 768;
            const isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
            const maxArcs = isMobile ? 30 : (isTablet ? 50 : 100);
            const displayArcs = arcs.slice(0, maxArcs);
            
            // Group arcs by source country to add offsets for multiple connections
            const arcsBySource = {};
            displayArcs.forEach(arc => {
                const key = arc.sourceCountry;
                if (!arcsBySource[key]) {
                    arcsBySource[key] = [];
                }
                arcsBySource[key].push(arc);
            });
            
            // Add rank and offset to each arc
            displayArcs.forEach((arc, index) => {
                arc.rank = index + 1;
                
                // Add curve offset for multiple arcs from same source
                const sourceArcs = arcsBySource[arc.sourceCountry];
                if (sourceArcs.length > 1) {
                    const arcIndex = sourceArcs.indexOf(arc);
                    const totalArcs = sourceArcs.length;
                    // Distribute offsets evenly from -0.5 to 0.5
                    arc.curveOffset = (arcIndex - (totalArcs - 1) / 2) * 0.2;
                } else {
                    arc.curveOffset = 0;
                }
            });
            
            console.log(`Total trade routes: ${totalTradeRoutes}, Displaying top ${displayArcs.length} of ${arcs.length}`);
            console.log(`First arc sample:`, displayArcs[0]);
            
            return {
                arcs: displayArcs,  // Return limited arcs with rank information
                totalRoutes: totalTradeRoutes
            };
        }

        // Populate commodity dropdown with available commodities
        function populateCommodityDropdown(impactData) {
            const commodities = Object.keys(impactData).sort();
            window.availableCommodities = commodities; // Store for autocomplete
            
            // Show the commodity selector
            document.getElementById('commodity-selector').style.display = 'block';
            
            // Initialize autocomplete functionality
            initializeCommodityAutocomplete(commodities);
        }
        
        // Initialize the autocomplete functionality
        function initializeCommodityAutocomplete(commodities) {
            const input = document.getElementById('commodity-input');
            const dropdown = document.getElementById('commodity-dropdown');
            const clearBtn = document.getElementById('commodity-clear');
            const selector = document.getElementById('commodity-selector');
            let highlightedIndex = -1;
            
            // Common aliases for food types
            const commodityAliases = {
                'beef': ['cattle', 'bovine'],
                'pork': ['pig', 'swine', 'hog'],
                'chicken': ['poultry', 'fowl'],
                'lamb': ['sheep', 'mutton'],
                'corn': ['maize'],
                'soybeans': ['soya', 'soy'],
                'wheat': ['grain'],
                'fish': ['seafood', 'marine'],
                'shrimp': ['prawn', 'crustacean'],
                'dairy': ['milk', 'cheese', 'butter'],
                'eggs': ['egg'],
                'rice': ['paddy'],
                'potato': ['potatoes'],
                'tomato': ['tomatoes'],
                'sugar': ['sugarcane', 'sugar beet'],
                'coffee': ['coffee bean'],
                'cocoa': ['chocolate', 'cacao'],
                'palm': ['palm oil'],
                'olive': ['olive oil']
            };
            
            // Set initial value if commodity is already selected
            if (selectedCommodity) {
                input.value = selectedCommodity;
                selector.classList.add('has-value');
            }
            
            // Function to filter and display commodities
            function filterCommodities(searchTerm) {
                if (!searchTerm) {
                    return commodities;
                }
                
                const lowerSearch = searchTerm.toLowerCase();
                const filtered = new Set();
                
                // Direct matches
                commodities.forEach(c => {
                    if (c.toLowerCase().includes(lowerSearch)) {
                        filtered.add(c);
                    }
                });
                
                // Check aliases
                Object.entries(commodityAliases).forEach(([alias, targets]) => {
                    if (alias.includes(lowerSearch)) {
                        // User typed an alias, find matching commodities
                        commodities.forEach(c => {
                            const lowerCommodity = c.toLowerCase();
                            if (targets.some(target => lowerCommodity.includes(target))) {
                                filtered.add(c);
                            }
                        });
                    }
                    // Also check if search matches any target
                    targets.forEach(target => {
                        if (target.includes(lowerSearch)) {
                            commodities.forEach(c => {
                                if (c.toLowerCase().includes(target)) {
                                    filtered.add(c);
                                }
                            });
                        }
                    });
                });
                
                return Array.from(filtered);
            }
            
            // Function to display filtered commodities in dropdown
            function displayFilteredCommodities(searchTerm) {
                const filtered = filterCommodities(searchTerm);
                
                dropdown.innerHTML = '';
                
                // Add "All commodities" option at the top
                const allOption = document.createElement('div');
                allOption.className = 'commodity-option';
                if (!selectedCommodity) allOption.classList.add('selected');
                allOption.textContent = 'All commodities';
                allOption.onclick = () => selectCommodity('');
                dropdown.appendChild(allOption);
                
                // Add filtered commodities
                filtered.forEach(commodity => {
                    const option = document.createElement('div');
                    option.className = 'commodity-option';
                    if (commodity === selectedCommodity) option.classList.add('selected');
                    option.textContent = commodity;
                    option.onclick = () => selectCommodity(commodity);
                    dropdown.appendChild(option);
                });
                
                highlightedIndex = -1;
                return filtered.length > 0 || !searchTerm;
            }
            
            // Function to select a commodity
            function selectCommodity(commodity) {
                selectedCommodity = commodity;
                input.value = commodity || '';
                dropdown.classList.remove('show');
                selector.classList.toggle('has-value', commodity !== '');
                
                // Trigger visualization refresh
                console.log(`Selected commodity: ${selectedCommodity || 'All'}`);
                refreshVisualization();
            }
            
            // Input event handlers
            input.addEventListener('focus', () => {
                displayFilteredCommodities(input.value);
                dropdown.classList.add('show');
            });
            
            input.addEventListener('input', (e) => {
                const hasResults = displayFilteredCommodities(e.target.value);
                dropdown.classList.toggle('show', hasResults);
                selector.classList.toggle('has-value', e.target.value !== '');
            });
            
            // Keyboard navigation
            input.addEventListener('keydown', (e) => {
                const options = dropdown.querySelectorAll('.commodity-option');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && options[highlightedIndex]) {
                        options[highlightedIndex].click();
                    } else if (input.value) {
                        // Find exact match
                        const exactMatch = commodities.find(c => c.toLowerCase() === input.value.toLowerCase());
                        selectCommodity(exactMatch || '');
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    input.blur();
                }
                
                // Update highlight
                options.forEach((option, index) => {
                    option.classList.toggle('highlighted', index === highlightedIndex);
                });
            });
            
            // Clear button
            clearBtn.addEventListener('click', () => {
                selectCommodity('');
                input.focus();
            });
            
            // Click outside to close
            document.addEventListener('click', (e) => {
                if (!selector.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Function to filter to a specific commodity
        function filterToCommodity(commodity) {
            selectedCommodity = commodity;
            const input = document.getElementById('commodity-input');
            if (input) {
                input.value = commodity;
                document.getElementById('commodity-selector').classList.add('has-value');
            }
            refreshVisualization();
        }
        
        // Refresh the visualization with current filters
        function refreshVisualization() {
            if (!selectedCountry || !impactData[selectedCountry]) {
                return;
            }
            
            // Create arcs with current commodity filter
            const { arcs, totalRoutes } = createArcsFromImpactData(selectedCountry, impactData[selectedCountry]);
            currentArcs = arcs;
            
            // Update globe with arcs
            console.log(`Updating globe with ${arcs.length} arcs (commodity: ${selectedCommodity || 'all'})`);
            globe.arcsData(arcs);
            
            // Create labels only for top 30 arc endpoints (source countries)
            const labels = [];
            const labeledCountries = new Set();
            
            // Only create labels for top 30 arcs
            const top30Arcs = arcs.slice(0, 30);
            
            top30Arcs.forEach(arc => {
                // Add label for source country if not already added
                if (!labeledCountries.has(arc.sourceCountry)) {
                    labels.push({
                        lat: arc.startLat,
                        lng: arc.startLng,
                        country: arc.sourceCountry.toUpperCase()
                    });
                    labeledCountries.add(arc.sourceCountry);
                }
            });
            
            // Add label for the selected target country
            const targetCoords = countryCoordinates[selectedCountry] || countryCoordinates[selectedCountry.toUpperCase()];
            if (targetCoords) {
                labels.push({
                    lat: targetCoords.lat,
                    lng: targetCoords.lng,
                    country: selectedCountry.toUpperCase()
                });
            }
            
            // Update labels on globe using HTML elements
            console.log(`Setting ${labels.length} labels on globe:`, labels);
            globe.htmlElementsData(labels);
            
            // Update data inbox
            updateDataInbox(arcs);
            
            // Scroll impact data panel back to top after DOM updates
            setTimeout(() => {
                const dataInbox = document.getElementById('data-inbox');
                if (dataInbox) {
                    dataInbox.scrollTop = 0;
                }
            }, 50); // Small delay to ensure DOM is updated
            
            // Re-render polygons to update source country colors
            globe.polygonsData(countryData);
            
            // Update UI with summary
            const countryName = getCountryName(selectedCountry);
            const commodityText = selectedCommodity ? ` - ${selectedCommodity}` : ' - All commodities';
            document.getElementById('selected-country').textContent = 
                `${countryName}${commodityText} (${totalRoutes})`;
        }

        // Select a country - make it globally accessible
        window.selectCountry = async function(countryCode) {
            selectedCountry = countryCode;
            // Keep the current commodity selection instead of resetting
            const previousCommodity = selectedCommodity;
            
            // Update UI
            const countryName = getCountryName(countryCode);
            document.getElementById('selected-country').textContent = 
                `Loading data for: ${countryName}`;
            
            // Log for debugging
            console.log(`Selected country: ${countryCode}`);
            console.log(`Keeping commodity filter: ${previousCommodity || 'All'}`);
            
            // Clear existing labels first
            globe.htmlElementsData([]);
            
            // Load impact data for the selected country
            const countryImpactData = await loadImpactData(countryCode);
            impactData[countryCode] = countryImpactData;
            
            // Populate commodity dropdown
            populateCommodityDropdown(countryImpactData);
            
            // Check if the previous commodity exists in the new country's data
            if (previousCommodity && countryImpactData[previousCommodity]) {
                // Keep the previous commodity selection
                selectedCommodity = previousCommodity;
                const input = document.getElementById('commodity-input');
                if (input) {
                    input.value = previousCommodity;
                    document.getElementById('commodity-selector').classList.add('has-value');
                }
            } else if (previousCommodity) {
                // Commodity doesn't exist for this country, reset to all
                console.log(`Commodity "${previousCommodity}" not available for ${countryCode}, showing all`);
                selectedCommodity = '';
                const input = document.getElementById('commodity-input');
                if (input) {
                    input.value = '';
                    document.getElementById('commodity-selector').classList.remove('has-value');
                }
            }
            
            // Refresh the visualization with current commodity filter
            refreshVisualization();
            
            // Ensure impact data panel is scrolled to top when selecting new country
            setTimeout(() => {
                const dataInbox = document.getElementById('data-inbox');
                if (dataInbox) {
                    dataInbox.scrollTop = 0;
                }
            }, 100); // Delay to ensure data is loaded
            
            // Position globe with selected country slightly above center for better arc visibility
            const targetCoords = countryCoordinates[countryCode] || countryCoordinates[countryCode.toUpperCase()];
            if (targetCoords) {
                // Offset latitude by -15 degrees to position country in upper portion of view
                globe.pointOfView({ lat: targetCoords.lat - 15, lng: targetCoords.lng, altitude: 2.0 }, 1000);
            }
            
            // Re-render polygons to update colors
            globe.polygonsData(countryData);
        }

        // Global function to close mobile panels
        window.closeMobilePanel = function() {
            const overlay = document.getElementById('mobile-overlay');
            const menuToggle = document.getElementById('mobile-menu-toggle');
            const panels = document.querySelectorAll('.mobile-visible');
            
            panels.forEach(panel => {
                panel.classList.remove('mobile-visible');
            });
            
            overlay.style.display = 'none';
            menuToggle.textContent = '☰ Info';
        };
        
        // Mobile panel management
        function setupMobileUI() {
            const menuToggle = document.getElementById('mobile-menu-toggle');
            const overlay = document.getElementById('mobile-overlay');
            const infoPanel = document.getElementById('info-panel');
            const dataInbox = document.getElementById('data-inbox');
            
            let currentPanel = null;
            
            // No separate close buttons needed - using menu toggle
            
            function showPanel(panel) {
                // Hide any current panel
                if (currentPanel && currentPanel !== panel) {
                    currentPanel.classList.remove('mobile-visible');
                }
                
                // Toggle the selected panel
                if (panel.classList.contains('mobile-visible')) {
                    panel.classList.remove('mobile-visible');
                    overlay.style.display = 'none';
                    currentPanel = null;
                    menuToggle.textContent = '☰ Menu';
                } else {
                    panel.classList.add('mobile-visible');
                    overlay.style.display = 'block';
                    currentPanel = panel;
                    
                    // Update button text to show close option
                    menuToggle.textContent = '✕ Close';
                }
            }
            
            // Menu toggle button handler
            menuToggle.addEventListener('click', () => {
                if (currentPanel) {
                    // Close current panel
                    currentPanel.classList.remove('mobile-visible');
                    overlay.style.display = 'none';
                    currentPanel = null;
                    menuToggle.textContent = '☰ Info';
                } else {
                    // Show info panel by default
                    showPanel(infoPanel);
                }
            });
            
            // Overlay click to close panels
            overlay.addEventListener('click', () => {
                if (currentPanel) {
                    currentPanel.classList.remove('mobile-visible');
                    overlay.style.display = 'none';
                    currentPanel = null;
                    menuToggle.textContent = '☰ Info';
                }
            });
            
            // Auto-show data panel on mobile when country is selected
            if (window.innerWidth <= 768) {
                const originalSelectCountry = window.selectCountry;
                window.selectCountry = async function(countryCode) {
                    await originalSelectCountry(countryCode);
                    // Show data panel after country selection on mobile
                    setTimeout(() => {
                        if (dataInbox.style.display !== 'none') {
                            showPanel(dataInbox);
                        }
                    }, 500);
                };
            }
            
            // Store showPanel globally for access
            window.showMobilePanel = showPanel;
            
            // Don't auto-show panel - let users interact with globe immediately
        }
        
        // Initialize everything
        async function init() {
            await loadAvailableCountries();
            initGlobe();
            setupMobileUI();
            
            // Adjust globe view for mobile
            if (window.innerWidth <= 768) {
                // Set a better initial view for mobile
                setTimeout(() => {
                    if (globe) {
                        globe.pointOfView({ lat: 20, lng: 0, altitude: 2.5 }, 1000);
                    }
                }, 1000);
            }
        }

        // Start the application
        init();
        
        // Track mouse position for tooltip
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            
            // Update tooltip position if it's visible
            const tooltip = document.getElementById('arc-tooltip');
            if (tooltip && tooltip.style.display === 'block') {
                // Position tooltip near cursor with offset
                tooltip.style.left = (mouseX + 15) + 'px';
                tooltip.style.top = (mouseY - 40) + 'px';
                
                // Keep tooltip on screen
                const rect = tooltip.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    tooltip.style.left = (mouseX - rect.width - 15) + 'px';
                }
                if (rect.top < 0) {
                    tooltip.style.top = (mouseY + 15) + 'px';
                }
            }
        });
        
        // Add event listeners for data inbox hover tracking
        document.addEventListener('DOMContentLoaded', () => {
            const dataInbox = document.getElementById('data-inbox');
            if (dataInbox) {
                dataInbox.addEventListener('mouseenter', () => {
                    isHoveringDataInbox = true;
                    // Clear any existing hover state when entering data inbox
                    if (hoveredCountry) {
                        hoveredCountry = null;
                        globe.polygonsData(countryData);
                    }
                });
                
                dataInbox.addEventListener('mouseleave', () => {
                    isHoveringDataInbox = false;
                });
            }
        });
    </script>
</body>
</html>
